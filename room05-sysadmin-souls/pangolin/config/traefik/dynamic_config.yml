http:
  middlewares:
    badger:
      plugin:
        badger:
          disableForwardAuth: true
    redirect-to-https:
      redirectScheme:
        scheme: https
    iocaine:
      plugin:
        iocaineBouncer:
          iocaineHttpUrl: http://iocaine:42069
          methods:
            - GET
            - HEAD
    ratelimit:
      rateLimit:
        average: 100
        burst: 200
        period: 1s

  routers:
    # HTTP to HTTPS redirect router
    main-app-router-redirect:
      rule: "Host(`cloud.reta.re`)"
      service: next-service
      entryPoints:
        - web
      middlewares:
        - redirect-to-https
        - badger

    # Next.js router (handles everything except API and WebSocket paths)
    next-router:
      rule: "Host(`cloud.reta.re`) && !PathPrefix(`/api`) && !PathPrefix(`/ws`)"
      service: next-service
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # API router (handles /api paths)
    api-router:
      rule: "Host(`cloud.reta.re`) && PathPrefix(`/api`)"
      service: api-service
      entryPoints:
        - websecure
      middlewares:
        - badger
      tls:
        certResolver: letsencrypt

    # WebSocket router
    ws-router:
      rule: "Host(`cloud.reta.re`) && PathPrefix(`/ws`)"
      service: api-service
      entryPoints:
        - websecure
      middlewares:
        - badger
      tls:
        certResolver: letsencrypt

  services:
    next-service:
      loadBalancer:
        servers:
          - url: "http://pangolin:3002" # Next.js server

    api-service:
      loadBalancer:
        servers:
          - url: "http://pangolin:3000" # API/WebSocket server
